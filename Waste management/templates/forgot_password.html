<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Forgot Password</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <style>
        /* (CSS styles from previous code should be included here or linked) */
        body {font-family: 'Roboto', sans-serif; background-color: #f0f4f8; display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0;}
        .reset-box {max-width: 400px; padding: 30px; border-radius: 8px; background-color: white; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);}
        input[type="text"], input[type="password"] {width: 100%; padding: 10px; margin-bottom: 15px; border: 1px solid #dcdfe4; border-radius: 4px; box-sizing: border-box;}
        button[type="submit"], button[type="button"] {width: 100%; padding: 12px; background-color: #ff9800; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; transition: background-color 0.3s;}
        button[type="submit"]:hover, button[type="button"]:hover {background-color: #e68a00;}
        .link {text-align: center; margin-top: 15px; font-size: 0.9em;}
        .messages {list-style: none; padding: 0; margin-bottom: 15px;}
        .messages li {font-size: 0.9em; margin-bottom: 5px; padding: 8px; border-radius: 4px;}
        .error { color: red; border: 1px solid #ffdddd; background-color: #ffeeee; }
        .success { color: green; border: 1px solid #ddffdd; background-color: #eeffee; }
        .step { display: none; }
    </style>
</head>
<body>
    <div class="reset-box">
        <h2 style="text-align: center; margin-top: 0;">Password Recovery</h2>
        
        {% with messages = get_flashed_messages(with_categories=True) %}
            {% if messages %}
                <ul class="messages">
                {% for category, message in messages %}
                    <li class="{{ category }}">{{ message }}</li>
                {% endfor %}
                </ul>
            {% endif %}
        {% endwith %}
        
        <form id="resetForm" method="POST">
            
            <div id="reset_step1">
                <p style="font-weight: bold;">Enter your registered mobile number:</p>
                <label for="reset_mobile">Mobile Number:</label>
                <input type="text" id="reset_mobile" required minlength="10" maxlength="15">
                
                <button type="button" id="requestOtpBtn">Request OTP</button>
            </div>
            
            <div id="reset_step2" class="step">
                <p id="otpResetMessage" class="success" style="font-size: 0.9em;"></p>

                <label for="otp">Enter OTP (Mock: 1234):</label>
                <input type="text" id="otp" name="otp" required minlength="4" maxlength="4">
                
                <label for="new_password">New Password:</label>
                <input type="password" id="new_password" name="new_password" required>
                
                <input type="hidden" name="mobile_hidden">
                
                <button type="submit">Reset Password</button>
            </div>
        </form>
        
        <p class="link">
            <a href="{{ url_for('login') }}">Back to Login</a>
        </p>
    </div>

    <script>
        $(document).ready(function() {
            $('#reset_step1').show();

            $('#requestOtpBtn').click(function() {
                var mobile = $('#reset_mobile').val();

                if (!mobile || mobile.length < 10) {
                    alert('Please enter a valid mobile number.');
                    return;
                }

                // Call the API to request OTP for reset
                $.post('/request_otp', { mobile: mobile, action: 'reset' })
                    .done(function(data) {
                        if (data.success) {
                            $('#reset_step1').hide();
                            $('#reset_step2').show();
                            $('#otpResetMessage').text(data.message);
                            // Cache the mobile number in a hidden field
                            $('input[name="mobile_hidden"]').val(mobile);
                            $('#reset_mobile').prop('disabled', true); // Visually disable for security
                        } else {
                            alert('OTP Request Failed: ' + data.message);
                        }
                    })
                    .fail(function() {
                        alert('Error contacting the server.');
                    });
            });
            
            // Handle form submission (Step 2)
            $('#resetForm').submit(function(e) {
                if ($('#reset_step2').is(':visible')) {
                    $('#reset_mobile').prop('disabled', false); // Re-enable for the final post
                    return true; 
                }
                e.preventDefault();
                return false;
            });
        });
    </script>
</body>
</html>